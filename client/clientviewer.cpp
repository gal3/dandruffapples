#include "client.h"

//"About" toolbar button handler
void on_About_clicked(GtkWidget *widget, gpointer window) {
	GtkWidget *dialog = gtk_about_dialog_new();
	gtk_about_dialog_set_name(GTK_ABOUT_DIALOG(dialog), "Client Viewer");
	gtk_about_dialog_set_version(GTK_ABOUT_DIALOG(dialog), "0.1");
	gtk_about_dialog_set_copyright(GTK_ABOUT_DIALOG(dialog), "(c) Team 2");
	gtk_about_dialog_set_comments(
			GTK_ABOUT_DIALOG(dialog),
			"Client Viewer is a program to create a real-time visual representation of the a single robot as generated by the client.");
	const gchar
			*authors[2] = {
					"Peter Neufeld, Frank Lau, Egor Philippov,\nYouyou Yang, Jianfeng Hu, Roy Chiang,\nWilson Huynh, Gordon Leung, Kevin Fahy,\nBenjamin Saunders",
					NULL };

	gtk_about_dialog_set_authors(GTK_ABOUT_DIALOG(dialog), authors);
	gtk_dialog_run(GTK_DIALOG(dialog));
	gtk_widget_destroy(dialog);
}

//window destruction methods for the info window
void infoDestroy(GtkWidget *window, gpointer widget) {
	gtk_widget_hide_all(GTK_WIDGET(window));
	gtk_toggle_tool_button_set_active(GTK_TOGGLE_TOOL_BUTTON(widget), FALSE);
}

gboolean infoDeleteEvent(GtkWidget *window, GdkEvent *event, gpointer widget) {
	infoDestroy(window, widget);

	return TRUE;
}

//"Info" toolbar button handler
void on_Window_toggled(GtkWidget *widget, gpointer window) {
	GdkColor bgColor;
	gdk_color_parse("black", &bgColor);
	gtk_widget_modify_bg(GTK_WIDGET(window), GTK_STATE_NORMAL, &bgColor);

	if (gtk_toggle_tool_button_get_active(GTK_TOGGLE_TOOL_BUTTON(widget)))
		gtk_widget_show_all(GTK_WIDGET(window));
	else
		gtk_widget_hide_all(GTK_WIDGET(window));
}

//called when the spin button value is changed
void on_RobotId_changed(GtkWidget *widget, gpointer data) {
	int *viewedRobot = (int*) data;

	int changedRobotId = gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(widget));

	if (*viewedRobot != changedRobotId)
		*viewedRobot = changedRobotId;
}
//ClientViewer::
//update the drawing of the robot
void ClientViewer::updateViewer(OwnRobot* ownRobot) {
#ifdef DEBUG
	debug<<"Drawing robot: "<<viewedRobot<<endl;
#endif

	cairo_surface_t *image= cairo_image_surface_create(IMAGEFORMAT, robotDiameter * drawFactor * 2 + viewDistance * drawFactor,
			robotDiameter * drawFactor * 2 + viewDistance * drawFactor);
	cairo_t *cr = gdk_cairo_create(drawingArea->widget.window);

	//paint a white background
	cairo_set_source_rgb(cr, 1, 1, 1);
	cairo_paint (cr);

	cairo_set_source_rgb(cr, .5, .5, .5);
	cairo_arc(cr, imageWidth/2, imageHeight/2, robotDiameter/2, 0, 2*M_PI );

	cairo_set_source_surface(cr, image, 0, 0);
	cairo_paint(cr);

	cairo_surface_destroy( image);
	cairo_destroy(cr);
}

//initializations and simple modifications for the things that will be drawn
void ClientViewer::initClientViewer(int numberOfRobots, int _robotDiameter, int _viewDistance, int _drawFactor) {
#ifdef DEBUG
	debug<<"Starting the Client Viewer!"<<endl;
#endif
	g_type_init();

	//load the builder file
	gtk_builder_add_from_file(builder, builderPath.c_str(), NULL);
	gtk_builder_connect_signals(builder, NULL);

	GtkWidget *mainWindow = GTK_WIDGET(gtk_builder_get_object(builder, "window"));
	GtkToggleToolButton *info = GTK_TOGGLE_TOOL_BUTTON(gtk_builder_get_object(builder, "Info"));
	GtkWidget *about = GTK_WIDGET(gtk_builder_get_object(builder, "About"));
	GtkWidget *infoWindow = GTK_WIDGET(gtk_builder_get_object(builder, "infoWindow"));
	GtkSpinButton *robotId = GTK_SPIN_BUTTON(gtk_builder_get_object(builder, "robotId"));
	GdkColor color;

	//drawing related variables
	robotDiameter = _robotDiameter;
	viewDistance = _viewDistance;
	drawFactor = _drawFactor;
	imageWidth=robotDiameter * drawFactor * 2 + viewDistance * drawFactor;
	imageHeight=robotDiameter * drawFactor * 2 + viewDistance * drawFactor;
	drawingArea = GTK_DRAWING_AREA(gtk_builder_get_object(builder, "drawingArea"));
	//make sure we have enough space to draw a robot, the viewdistance around it and an extra robot length in case a robot is visible right on the boundary
	gtk_widget_set_size_request(GTK_WIDGET(drawingArea), imageWidth, imageHeight);

	//set the upper value for the spin button
	gtk_adjustment_set_upper(GTK_ADJUSTMENT(gtk_builder_get_object(builder, "robotIdAdjustment")), numberOfRobots - 1);
	gtk_adjustment_set_value(GTK_ADJUSTMENT(gtk_builder_get_object(builder, "robotIdAdjustment")), -1);
	//keep the info window floating on top of the main window
	gtk_window_set_keep_above(GTK_WINDOW(infoWindow), true);

	//change the color of the main window's background to black
	gdk_color_parse("black", &color);
	gtk_widget_modify_bg(GTK_WIDGET(mainWindow), GTK_STATE_NORMAL, &color);

	//change the color of the label's text to white
	gdk_color_parse("white", &color);
	//gtk_widget_modify_fg(GTK_WIDGET(gtk_builder_get_object(builder, "robotWindowLabel")), GTK_STATE_NORMAL, &color);

	g_signal_connect(robotId, "value-changed", G_CALLBACK(on_RobotId_changed), (gpointer) & viewedRobot);

	g_signal_connect(info, "toggled", G_CALLBACK(on_Window_toggled), (gpointer) infoWindow);
	g_signal_connect(about, "clicked", G_CALLBACK(on_About_clicked), (gpointer) mainWindow);

	g_signal_connect(infoWindow, "destroy", G_CALLBACK(infoDestroy), (gpointer) info);
	g_signal_connect(infoWindow, "delete-event", G_CALLBACK(infoDeleteEvent), (gpointer) info);

	gtk_widget_show_all(mainWindow);
}

ClientViewer::ClientViewer(int argc, char* argv[]) :
	viewedRobot(-1) {

	//assume that the clientviewer.builder is in the same directory as the executable that we are running
	builderPath = argv[0];
	builderPath = builderPath.substr(0, builderPath.find_last_of("//") + 1) + "clientviewer.glade";
	builder = gtk_builder_new();

#ifdef DEBUG
	debug.open(helper::clientViewerDebugLogName.c_str(), ios::out);
#endif
}

ClientViewer::~ClientViewer() {
	g_object_unref( G_OBJECT(builder));
#ifdef DEBUG
	debug.close();
#endif
}
